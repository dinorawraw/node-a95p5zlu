<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <script src="https://unpkg.com/vue@3.5.13/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="/src/styles/main.css">
</head>
<body class="min-h-screen bg-gradient-to-br from-[#04456c] via-[#391334] to-[#04244c]">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">Painel Administrativo</h1>
            <div class="flex gap-4">
                <button 
                    @click="logout"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                >
                    Sair
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-lg shadow-xl p-6">
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex">
                    <button 
                        @click="activeTab = 'users'"
                        :class="[
                            'py-2 px-4 font-medium',
                            activeTab === 'users' 
                                ? 'border-b-2 border-blue-500 text-blue-600'
                                : 'text-gray-500 hover:text-gray-700'
                        ]"
                    >
                        Usuários
                    </button>
                    <button 
                        @click="activeTab = 'news'"
                        :class="[
                            'py-2 px-4 font-medium ml-8',
                            activeTab === 'news' 
                                ? 'border-b-2 border-blue-500 text-blue-600'
                                : 'text-gray-500 hover:text-gray-700'
                        ]"
                    >
                        Notícias
                    </button>
                    <button 
                        @click="activeTab = 'calculations'"
                        :class="[
                            'py-2 px-4 font-medium ml-8',
                            activeTab === 'calculations' 
                                ? 'border-b-2 border-blue-500 text-blue-600'
                                : 'text-gray-500 hover:text-gray-700'
                        ]"
                    >
                        Cálculos
                    </button>
                </nav>
            </div>

            <!-- Content -->
            <div class="mt-6">
                <!-- Users Tab -->
                <div v-if="activeTab === 'users'" class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Gerenciamento de Usuários</h2>
                        <button 
                            @click="showAddUserModal = true"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            Adicionar Usuário
                        </button>
                    </div>

                    <div class="flex gap-4">
                        <input 
                            type="text" 
                            v-model="userSearch" 
                            placeholder="Buscar usuários..."
                            class="flex-1 p-2 border rounded-lg"
                        >
                        <select 
                            v-model="userFilter" 
                            class="p-2 border rounded-lg"
                        >
                            <option value="all">Todos</option>
                            <option value="admin">Administradores</option>
                            <option value="user">Usuários</option>
                        </select>
                    </div>

                    <div v-if="loading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
                        <p class="mt-2 text-gray-600">Carregando usuários...</p>
                    </div>

                    <div v-else-if="error" class="text-center py-8">
                        <p class="text-red-600">{{ error }}</p>
                        <button 
                            @click="loadUsers"
                            class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            Tentar Novamente
                        </button>
                    </div>

                    <div v-else class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">E-mail</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Função</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data de Cadastro</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="user in filteredUsers" :key="user.id">
                                    <td class="px-6 py-4 whitespace-nowrap">{{ user.username }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">{{ user.name }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">{{ user.email }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="[
                                            'px-2 py-1 text-xs font-medium rounded-full',
                                            user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'
                                        ]">
                                            {{ user.role === 'admin' ? 'Administrador' : 'Usuário' }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ formatDate(user.created_at) }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <button 
                                            @click="editUser(user)"
                                            class="text-blue-600 hover:text-blue-900 mr-4"
                                        >
                                            Editar
                                        </button>
                                        <button 
                                            @click="confirmDeleteUser(user)"
                                            class="text-red-600 hover:text-red-900"
                                            :disabled="user.role === 'admin'"
                                            :class="{ 'opacity-50 cursor-not-allowed': user.role === 'admin' }"
                                        >
                                            Excluir
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- News Tab -->
                <div v-if="activeTab === 'news'" class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Gerenciamento de Notícias</h2>
                        <button 
                            @click="showAddNewsModal = true"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            Nova Notícia
                        </button>
                    </div>

                    <div v-if="loadingNews" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
                        <p class="mt-2 text-gray-600">Carregando notícias...</p>
                    </div>

                    <div v-else-if="newsError" class="text-center py-8">
                        <p class="text-red-600">{{ newsError }}</p>
                        <button 
                            @click="loadNews"
                            class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            Tentar Novamente
                        </button>
                    </div>

                    <div v-else class="space-y-4">
                        <div v-for="item in news" :key="item.id" class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-bold">{{ item.title }}</h3>
                                    <p class="text-sm text-gray-600">{{ formatDate(item.created_at) }}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button 
                                        @click="editNews(item)"
                                        class="text-blue-600 hover:text-blue-900"
                                    >
                                        Editar
                                    </button>
                                    <button 
                                        @click="confirmDeleteNews(item)"
                                        class="text-red-600 hover:text-red-900"
                                    >
                                        Excluir
                                    </button>
                                </div>
                            </div>
                            <p class="mt-2 text-gray-700">{{ item.content }}</p>
                            <div v-if="item.image" class="mt-2">
                                <img :src="item.image" :alt="item.title" class="h-20 w-auto object-cover rounded">
                            </div>
                            <div v-if="item.video" class="mt-2">
                                <video class="h-20 w-auto object-cover rounded" controls>
                                    <source :src="item.video" type="video/mp4">
                                </video>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calculations Tab -->
                <div v-if="activeTab === 'calculations'" class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Histórico de Cálculos</h2>
                        <div class="flex gap-4">
                            <select 
                                v-model="calculationsFilter.userId"
                                class="p-2 border rounded-lg"
                            >
                                <option value="all">Todos os Usuários</option>
                                <option v-for="user in users" :key="user.id" :value="user.id">
                                    {{ user.username }}
                                </option>
                            </select>
                            <select 
                                v-model="calculationsFilter.type"
                                class="p-2 border rounded-lg"
                            >
                                <option value="all">Todos os Tipos</option>
                                <option value="instagram">Instagram</option>
                                <option value="tiktok">TikTok</option>
                            </select>
                        </div>
                    </div>

                    <div v-if="loadingCalculations" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
                        <p class="mt-2 text-gray-600">Carregando cálculos...</p>
                    </div>

                    <div v-else-if="calculationsError" class="text-center py-8">
                        <p class="text-red-600">{{ calculationsError }}</p>
                        <button 
                            @click="loadCalculations"
                            class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            Tentar Novamente
                        </button>
                    </div>

                    <div v-else class="space-y-4">
                        <div v-for="calc in filteredCalculations" :key="calc.id" class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h3 class="text-lg font-bold">{{ calc.name }}</h3>
                                        <span :class="[
                                            'px-2 py-1 text-xs font-medium rounded-full',
                                            calc.type === 'instagram' ? 'bg-pink-100 text-pink-800' : 'bg-black text-white'
                                        ]">
                                            {{ calc.type === 'instagram' ? 'Instagram' : 'TikTok' }}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600">
                                        {{ getUserName(calc.user_id) }} • {{ formatDate(calc.created_at) }}
                                    </p>
                                </div>
                                <button 
                                    @click="confirmDeleteCalculation(calc)"
                                    class="text-red-600 hover:text-red-900"
                                >
                                    Excluir
                                </button>
                            </div>
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <div v-if="calc.type === 'instagram'">
                                    <p class="text-sm text-gray-600">Seguidores: {{ formatNumber(calc.data.followers) }}</p>
                                    <p class="text-sm text-gray-600">Alcance Mínimo: {{ calc.data.minReach }}%</p>
                                    <p class="text-sm text-gray-600">Alcance Máximo: {{ calc.data.maxReach }}%</p>
                                    <p class="text-sm text-gray-600">Engajamento: {{ calc.data.engagement }}%</p>
                                    <p class="text-sm font-medium mt-2">
                                        Stories: R$ {{ formatCurrency(calc.data.storiesValue) }}
                                    </p>
                                    <p class="text-sm font-medium">
                                        Reels: R$ {{ formatCurrency(calc.data.reelsValue) }}
                                    </p>
                                </div>
                                <div v-else>
                                    <p class="text-sm text-gray-600">Seguidores: {{ formatNumber(calc.data.followers) }}</p>
                                    <p class="text-sm text-gray-600">Visualizações: {{ formatNumber(calc.data.views) }}</p>
                                    <p class="text-sm text-gray-600">Curtidas: {{ formatNumber(calc.data.likes) }}</p>
                                    <p class="text-sm text-gray-600">Comentários: {{ formatNumber(calc.data.comments) }}</p>
                                    <p class="text-sm font-medium mt-2">
                                        Valor Total: R$ {{ formatCurrency(calc.data.totalValue) }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <!-- Add/Edit User Modal -->
        <div v-if="showAddUserModal || showEditUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-bold mb-4">{{ showEditUserModal ? 'Editar Usuário' : 'Adicionar Novo Usuário' }}</h3>
                <form @submit.prevent="saveUser" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Usuário</label>
                        <input 
                            type="text" 
                            v-model="userForm.username" 
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nome</label>
                        <input 
                            type="text" 
                            v-model="userForm.name" 
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">E-mail</label>
                        <input 
                            type="email" 
                            v-model="userForm.email" 
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">
                            Senha {{ showEditUserModal ? '(deixe em branco para manter a atual)' : '' }}
                        </label>
                        <input 
                            type="password" 
                            v-model="userForm.password" 
                            :required="!showEditUserModal"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Função</label>
                        <select 
                            v-model="userForm.role"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                            <option value="user">Usuário</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>

                    <div v-if="userFormError" class="text-sm text-red-600">
                        {{ userFormError }}
                    </div>

                    <div class="flex justify-end gap-4">
                        <button 
                            type="button"
                            @click="closeUserModal"
                            class="px-4 py-2 text-gray-700 hover:text-gray-900"
                        >
                            Cancelar
                        </button>
                        <button 
                            type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                            :disabled="userFormLoading"
                        >
                            {{ userFormLoading ? 'Salvando...' : (showEditUserModal ? 'Salvar Alterações' : 'Adicionar Usuário') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add/Edit News Modal -->
        <div v-if="showAddNewsModal || showEditNewsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-bold mb-4">{{ showEditNewsModal ? 'Editar Notícia' : 'Nova Notícia' }}</h3>
                <form @submit.prevent="saveNews" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Título</label>
                        <input 
                            type="text" 
                            v-model="newsForm.title" 
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Conteúdo</label>
                        <textarea 
                            v-model="newsForm.content" 
                            required
                            rows="4"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        ></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">URL da Imagem (opcional)</label>
                        <input 
                            type="url" 
                            v-model="newsForm.image"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">URL do Vídeo (opcional)</label>
                        <input 
                            type="url" 
                            v-model="newsForm.video"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                    </div>

                    <div v-if="newsFormError" class="text-sm text-red-600">
                        {{ newsFormError }}
                    </div>

                    <div class="flex justify-end gap-4">
                        <button 
                            type="button"
                            @click="closeNewsModal"
                            class="px-4 py-2 text-gray-700 hover:text-gray-900"
                        >
                            Cancelar
                        </button>
                        <button 
                            type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                            :disabled="newsFormLoading"
                        >
                            {{ newsFormLoading ? 'Salvando...' : (showEditNewsModal ? 'Salvar Alterações' : 'Publicar Notícia') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete User Confirmation Modal -->
        <div v-if="showDeleteUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-bold mb-4">Confirmar Exclusão</h3>
                <p class="text-gray-600 mb-6">
                    Tem certeza que deseja excluir o usuário "{{ userToDelete?.username }}"? Esta ação não pode ser desfeita.
                </p>
                <div class="flex justify-end gap-4">
                    <button 
                        @click="showDeleteUserModal = false"
                        class="px-4 py-2 text-gray-700 hover:text-gray-900"
                    >
                        Cancelar
                    </button>
                    <button 
                        @click="deleteUser"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                        :disabled="deleteUserLoading"
                    >
                        {{ deleteUserLoading ? 'Excluindo...' : 'Excluir' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete News Confirmation Modal -->
        <div v-if="showDeleteNewsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-bold mb-4">Confirmar Exclusão</h3>
                <p class="text-gray-600 mb-6">
                    Tem certeza que deseja excluir a notícia "{{ newsToDelete?.title }}"? Esta ação não pode ser desfeita.
                </p>
                <div class="flex justify-end gap-4">
                    <button 
                        @click="showDeleteNewsModal = false"
                        class="px-4 py-2 text-gray-700 hover:text-gray-900"
                    >
                        Cancelar
                    </button>
                    <button 
                        @click="deleteNews"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                        :disabled="deleteNewsLoading"
                    >
                        {{ deleteNewsLoading ? 'Excluindo...' : 'Excluir' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Calculation Confirmation Modal -->
        <div v-if="showDeleteCalculationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-bold mb-4">Confirmar Exclusão</h3>
                <p class="text-gray-600 mb-6">
                    Tem certeza que deseja excluir este cálculo? Esta ação não pode ser desfeita.
                </p>
                <div class="flex justify-end gap-4">
                    <button 
                        @click="showDeleteCalculationModal = false"
                        class="px-4 py-2 text-gray-700 hover:text-gray-900"
                    >
                        Cancelar
                    </button>
                    <button 
                        @click="deleteCalculation"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                        :disabled="deleteCalculationLoading"
                    >
                        {{ deleteCalculationLoading ? 'Excluindo...' : 'Excluir' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import db from '/src/lib/db.js';

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Tab Control
                    activeTab: 'users',
                    
                    // Users Data
                    users: [],
                    loading: false,
                    error: null,
                    userSearch: '',
                    userFilter: 'all',
                    
                    // News Data
                    news: [],
                    loadingNews: false,
                    newsError: null,
                    showAddNewsModal: false,
                    showEditNewsModal: false,
                    showDeleteNewsModal: false,
                    newsToDelete: null,
                    deleteNewsLoading: false,
                    newsFormLoading: false,
                    newsFormError: null,
                    newsForm: {
                        title: '',
                        content: '',
                        image: '',
                        video: ''
                    },
                    
                    // Calculations Data
                    calculations: [],
                    loadingCalculations: false,
                    calculationsError: null,
                    calculationsFilter: {
                        userId: 'all',
                        type: 'all'
                    },
                    showDeleteCalculationModal: false,
                    calculationToDelete: null,
                    deleteCalculationLoading: false,
                    
                    // User Management Data
                    showAddUserModal: false,
                    showEditUserModal: false,
                    showDeleteUserModal: false,
                    userToDelete: null,
                    deleteUserLoading: false,
                    userFormLoading: false,
                    userFormError: null,
                    userForm: {
                        username: '',
                        name: '',
                        email: '',
                        password: '',
                        role: 'user'
                    }
                }
            },
            computed: {
                filteredUsers() {
                    let filtered = [...this.users];
                    
                    if (this.userFilter !== 'all') {
                        filtered = filtered.filter(user => user.role === this.userFilter);
                    }
                    
                    if (this.userSearch.trim()) {
                        const search = this.userSearch.toLowerCase().trim();
                        filtered = filtered.filter(user => 
                            user.username.toLowerCase().includes(search) ||
                            user.name.toLowerCase().includes(search) ||
                            user.email.toLowerCase().includes(search)
                        );
                    }
                    
                    return filtered;
                },
                filteredCalculations() {
                    let filtered = [...this.calculations];
                    
                    if (this.calculationsFilter.userId !== 'all') {
                        filtered = filtered.filter(calc => calc.user_id === this.calculationsFilter.userId);
                    }
                    
                    if (this.calculationsFilter.type !== 'all') {
                        filtered = filtered.filter(calc => calc.type === this.calculationsFilter.type);
                 }
                    
                    return filtered;
                }
            },
            async mounted() {
                // Check if user is admin
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.role !== 'admin') {
                    window.location.href = '/login.html';
                    return;
                }

                await this.loadInitialData();
            },
            methods: {
                async loadInitialData() {
                    await Promise.all([
                        this.loadUsers(),
                        this.loadNews(),
                        this.loadCalculations()
                    ]);
                },
                async loadUsers() {
                    this.loading = true;
                    this.error = null;

                    try {
                        this.users = await db.getUsers();
                    } catch (error) {
                        console.error('Erro ao carregar usuários:', error);
                        this.error = 'Falha ao carregar a lista de usuários. Por favor, tente novamente.';
                    } finally {
                        this.loading = false;
                    }
                },
                async loadNews() {
                    this.loadingNews = true;
                    this.newsError = null;

                    try {
                        this.news = await db.getNews();
                    } catch (error) {
                        console.error('Erro ao carregar notícias:', error);
                        this.newsError = 'Falha ao carregar notícias';
                    } finally {
                        this.loadingNews = false;
                    }
                },
                async loadCalculations() {
                    this.loadingCalculations = true;
                    this.calculationsError = null;
                    
                    try {
                        this.calculations = await db.getCalculations();
                    } catch (error) {
                        console.error('Erro ao carregar cálculos:', error);
                        this.calculationsError = 'Falha ao carregar histórico de cálculos';
                    } finally {
                        this.loadingCalculations = false;
                    }
                },
                editUser(user) {
                    this.userForm = { ...user, password: '' };
                    this.showEditUserModal = true;
                },
                confirmDeleteUser(user) {
                    if (user.role === 'admin') return;
                    this.userToDelete = user;
                    this.showDeleteUserModal = true;
                },
                async deleteUser() {
                    if (!this.userToDelete || this.userToDelete.role === 'admin') return;

                    this.deleteUserLoading = true;
                    try {
                        await db.deleteUser(this.userToDelete.id);
                        await this.loadUsers();
                        this.showDeleteUserModal = false;
                        this.userToDelete = null;
                    } catch (error) {
                        console.error('Erro ao excluir usuário:', error);
                        alert('Falha ao excluir usuário. Por favor, tente novamente.');
                    } finally {
                        this.deleteUserLoading = false;
                    }
                },
                async saveUser() {
                    this.userFormLoading = true;
                    this.userFormError = null;

                    try {
                        if (this.showEditUserModal) {
                            await db.updateUser(this.userForm.id, this.userForm);
                        } else {
                            await db.createUser(this.userForm);
                        }

                        await this.loadUsers();
                        this.closeUserModal();
                    } catch (error) {
                        console.error('Erro ao salvar usuário:', error);
                        this.userFormError = 'Falha ao salvar usuário. Por favor, tente novamente.';
                    } finally {
                        this.userFormLoading = false;
                    }
                },
                editNews(news) {
                    this.newsForm = { ...news };
                    this.showEditNewsModal = true;
                },
                confirmDeleteNews(news) {
                    this.newsToDelete = news;
                    this.showDeleteNewsModal = true;
                },
                async deleteNews() {
                    if (!this.newsToDelete) return;

                    this.deleteNewsLoading = true;
                    try {
                        await db.deleteNews(this.newsToDelete.id);
                        await this.loadNews();
                        this.showDeleteNewsModal = false;
                        this.newsToDelete = null;
                    } catch (error) {
                        console.error('Erro ao excluir notícia:', error);
                        alert('Falha ao excluir notícia');
                    } finally {
                        this.deleteNewsLoading = false;
                    }
                },
                async saveNews() {
                    this.newsFormLoading = true;
                    this.newsFormError = null;

                    try {
                        if (this.showEditNewsModal) {
                            await db.updateNews(this.newsForm.id, this.newsForm);
                        } else {
                            await db.createNews(this.newsForm);
                        }

                        await this.loadNews();
                        this.closeNewsModal();
                    } catch (error) {
                        console.error('Erro ao salvar notícia:', error);
                        this.newsFormError = error.message;
                    } finally {
                        this.newsFormLoading = false;
                    }
                },
                confirmDeleteCalculation(calculation) {
                    this.calculationToDelete = calculation;
                    this.showDeleteCalculationModal = true;
                },
                async deleteCalculation() {
                    if (!this.calculationToDelete) return;

                    this.deleteCalculationLoading = true;
                    try {
                        await db.deleteCalculation(this.calculationToDelete.id);
                        await this.loadCalculations();
                        this.showDeleteCalculationModal = false;
                        this.calculationToDelete = null;
                    } catch (error) {
                        console.error('Erro ao excluir cálculo:', error);
                        alert('Falha ao excluir cálculo');
                    } finally {
                        this.deleteCalculationLoading = false;
                    }
                },
                closeUserModal() {
                    this.showAddUserModal = false;
                    this.showEditUserModal = false;
                    this.userForm = {
                        username: '',
                        name: '',
                        email: '',
                        password: '',
                        role: 'user'
                    };
                    this.userFormError = null;
                },
                closeNewsModal() {
                    this.showAddNewsModal = false;
                    this.showEditNewsModal = false;
                    this.newsForm = {
                        title: '',
                        content: '',
                        image: '',
                        video: ''
                    };
                    this.newsFormError = null;
                },
                formatDate(date) {
                    return new Date(date).toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                formatCurrency(value) {
                    return Number(value).toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                },
                formatNumber(value) {
                    return Number(value).toLocaleString('pt-BR');
                },
                getUserName(userId) {
                    const user = this.users.find(u => u.id === userId);
                    return user ? user.username : 'Usuário Desconhecido';
                },
                logout() {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('currentUser');
                    window.location.href = '/login.html';
                }
            }
        }).mount('#app')
    </script>
</body>
</html>